<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Hello OpenCV.js</title>
    <script src="https://docs.opencv.org/3.4/opencv.js" type="text/javascript"></script>
    </script>
</head>

<body>
    <h2>Hello OpenCV.js</h2>
    <p id="status">OpenCV.js is loading...</p>
    <div>
        <div class="inputoutput">
            <img id="imageSrc" alt="No Image" />
            <div class="caption">imageSrc <input type="file" id="fileInput" name="file" /></div>
        </div>
        <div class="inputoutput">
            <canvas id="canvasOutput"></canvas>
            <div class="caption">canvasOutput</div>
        </div>
    </div>
    <script type="text/javascript">
        let imgElement = document.getElementById('imageSrc');
        let inputElement = document.getElementById('fileInput');
        inputElement.addEventListener('change', (e) => {
            imgElement.src = URL.createObjectURL(e.target.files[0]);
        }, false);
        imgElement.onload = function () {

            let { area, contour } = getMaxContour(gray);

            let dilateIterations = 0;

            const MAX_DILATE_ITERATIONS = 9;
            while (area < MINIMAL_POSSIBLE_AREA && dilateIterations < MAX_DILATE_ITERATIONS) {
                dilateIterations++;
                gray = gray.dilate(new cv.Mat(), new cv.Point(-1, -1), 1, cv.BORDER_CONSTANT);

                let result = getMaxContour(gray);
                contour = result.contour;
                area = result.area;

                if (DEBUG) {
                    writeImage(`dilated_${dilateIterations}.png`, gray);
                }
            }

            const getMaxContour = (image) => {
                const contours = image.findContours(cv.RETR_LIST, cv.CHAIN_APPROX_SIMPLE);
                let maxAreaFound = 0;
                let maxContour = [];
                let contourObj = null;
                console.log(`Found ${contours.length} contours.`);
                contours.forEach((contour, i) => {
                    // const perimeter = cv.arcLength(contour, true);
                    const perimeter = contour.arcLength(true);
                    const approx = contour.approxPolyDP(0.1 * perimeter, true);
                    const area = contour.moments()['m00'];

                    if (approx.length == 4 && maxAreaFound < area) {
                        maxAreaFound = area;
                        maxContour = approx;
                        contourObj = contour;
                    }
                });

                console.log(JSON.stringify(contourObj))
                console.log(`Max contour area found ${maxAreaFound}.`);

                return {
                    contour: maxContour,
                    area: maxAreaFound
                };
            }

            let mat = cv.imread(imgElement);
            cv.imshow('canvasOutput', mat);
            mat.delete();
        };



    </script>
</body>

</html>